generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CUSTOMER
  WORKER
  HARDWARE_STORE
  ADMIN
}

enum SkillType {
  MASON
  TILE_LAYER
  WELDER
  STEEL_FIXER
  CARPENTER
  PLUMBER
  ELECTRICIAN
  PAINTER
}

enum BookingStatus {
  PENDING
  ACCEPTED
  REJECTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum OrderStatus {
  PENDING
  ACCEPTED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum TransactionType {
  BOOKING_PAYMENT
  COMMISSION
  WITHDRAWAL
  REFUND
  MATERIAL_PURCHASE
}

enum NotificationType {
  BOOKING_CREATED
  BOOKING_ACCEPTED
  BOOKING_REJECTED
  BOOKING_COMPLETED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  ORDER_PLACED
  ORDER_ACCEPTED
  ORDER_DELIVERED
  REVIEW_RECEIVED
  WITHDRAWAL_COMPLETED
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  role          Role     @default(CUSTOMER)
  name          String
  phone         String?
  image         String?
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  profile         Profile?
  workerProfile   WorkerProfile?
  storeProfile    StoreProfile?
  bookings        Booking[]      @relation("CustomerBookings")
  workerBookings  Booking[]      @relation("WorkerBookings")
  projects        Project[]
  reviews         Review[]       @relation("ReviewAuthor")
  receivedReviews Review[]       @relation("ReviewRecipient")
  transactions    Transaction[]
  notifications   Notification[]
  estimates       Estimate[]

  @@index([email])
  @@index([role])
}

model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  address   String?
  city      String?
  state     String?
  zipCode   String?
  country   String?  @default("USA")
  latitude  Float?
  longitude Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkerProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill           SkillType
  dailyRate       Float
  hourlyRate      Float?
  experience      Int // years of experience
  bio             String?
  isVerified      Boolean   @default(false)
  isAvailable     Boolean   @default(true)
  address         String?
  city            String?
  state           String?
  zipCode         String?
  latitude        Float?
  longitude       Float?
  portfolioImages String[] // Array of image URLs
  certifications  String[] // Array of certification URLs
  rating          Float     @default(0)
  totalReviews    Int       @default(0)
  totalJobs       Int       @default(0)
  totalEarnings   Float     @default(0)
  walletBalance   Float     @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([skill])
  @@index([city])
  @@index([isAvailable])
  @@index([rating])
}

model StoreProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeName    String
  description  String?
  address      String
  city         String
  state        String
  zipCode      String
  latitude     Float?
  longitude    Float?
  phone        String
  isVerified   Boolean  @default(false)
  rating       Float    @default(0)
  totalReviews Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  products Product[]
  orders   Order[]

  @@index([city])
  @@index([isVerified])
}

model Booking {
  id            String        @id @default(cuid())
  customerId    String
  customer      User          @relation("CustomerBookings", fields: [customerId], references: [id])
  workerId      String
  worker        User          @relation("WorkerBookings", fields: [workerId], references: [id])
  projectId     String?
  project       Project?      @relation(fields: [projectId], references: [id])
  status        BookingStatus @default(PENDING)
  skill         SkillType
  startDate     DateTime
  endDate       DateTime
  startTime     String? // e.g., "09:00"
  endTime       String? // e.g., "17:00"
  totalHours    Float?
  totalDays     Int?
  ratePerDay    Float?
  ratePerHour   Float?
  totalAmount   Float
  commission    Float         @default(0)
  paymentStatus PaymentStatus @default(PENDING)
  paymentId     String?
  description   String?
  address       String
  city          String
  state         String
  zipCode       String
  latitude      Float?
  longitude     Float?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([customerId])
  @@index([workerId])
  @@index([status])
  @@index([startDate])
}

model Project {
  id          String    @id @default(cuid())
  customerId  String
  customer    User      @relation(fields: [customerId], references: [id])
  name        String
  description String?
  address     String
  city        String
  state       String
  zipCode     String
  startDate   DateTime
  endDate     DateTime?
  budget      Float?
  status      String    @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  progress    Int       @default(0) // 0-100
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  bookings  Booking[]
  tasks     Task[]
  materials Material[]
  estimates Estimate[]

  @@index([customerId])
  @@index([status])
}

model Task {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String?
  status      String    @default("TODO") // TODO, IN_PROGRESS, COMPLETED
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([projectId])
}

model Material {
  id         String   @id @default(cuid())
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name       String
  quantity   Float
  unit       String // bags, kg, pieces, etc.
  unitPrice  Float?
  totalPrice Float?
  supplier   String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([projectId])
}

model Estimate {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  name        String
  description String?
  items       Json // Array of {name, quantity, unit, unitPrice, totalPrice}
  totalCost   Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model Product {
  id          String       @id @default(cuid())
  storeId     String
  store       StoreProfile @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name        String
  description String?
  category    String
  unit        String // bags, kg, pieces, meters, etc.
  price       Float
  stock       Int          @default(0)
  images      String[]
  isAvailable Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  orderItems OrderItem[]

  @@index([storeId])
  @@index([category])
  @@index([isAvailable])
}

model Order {
  id              String        @id @default(cuid())
  customerId      String
  storeId         String
  store           StoreProfile  @relation(fields: [storeId], references: [id])
  orderNumber     String        @unique
  status          OrderStatus   @default(PENDING)
  totalAmount     Float
  paymentStatus   PaymentStatus @default(PENDING)
  paymentId       String?
  deliveryAddress String
  deliveryCity    String
  deliveryState   String
  deliveryZip     String
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  items OrderItem[]

  @@index([customerId])
  @@index([storeId])
  @@index([orderNumber])
  @@index([status])
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  quantity   Float
  unitPrice  Float
  totalPrice Float
  createdAt  DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

model Review {
  id          String   @id @default(cuid())
  authorId    String
  author      User     @relation("ReviewAuthor", fields: [authorId], references: [id])
  recipientId String
  recipient   User     @relation("ReviewRecipient", fields: [recipientId], references: [id])
  rating      Int // 1-5
  comment     String?
  bookingId   String?
  orderId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([authorId])
  @@index([recipientId])
}

model Transaction {
  id          String          @id @default(cuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id])
  type        TransactionType
  amount      Float
  status      PaymentStatus   @default(PENDING)
  description String?
  stripeId    String?
  bookingId   String?
  orderId     String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}
